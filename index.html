<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRULEGEND: Airdrop Hub</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #0088cc; --bg: #0a0a0b; --glass: rgba(255, 255, 255, 0.08); --border: rgba(255,255,255,0.12); --success: #4CAF50; --warning: #ff9800; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .header-ui { position: fixed; top: 0; width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); }
        .screen { display: none; padding: 20px; height: calc(100vh - 110px); overflow-y: auto; margin-top: 60px; box-sizing: border-box; padding-bottom: 100px; }
        .active-screen { display: block; }
        .card { background: var(--glass); padding: 18px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
        .balance { font-size: 3.5rem; font-weight: 900; text-align: center; margin-top: 20px; text-shadow: 0 0 25px var(--accent); letter-spacing: -2px; }
        .circle-btn { width: 220px; height: 220px; background: radial-gradient(circle at 30% 30%, #0088cc, #001a33); border-radius: 50%; margin: 30px auto; display: flex; align-items: center; justify-content: center; font-size: 6rem; box-shadow: 0 0 50px rgba(0,136,204,0.4); border: 8px solid var(--border); cursor: pointer; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        .circle-btn:active { transform: scale(0.95); }
        .rank-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 8px; border: 1px solid var(--border); }
        .badge { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 900; font-size: 0.8rem; margin-right: 12px; }
        .top1 { background: var(--gold); color: #000; }
        .top2 { background: var(--silver); color: #000; }
        .top3 { background: var(--bronze); color: #000; }
        .dock { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 12px 0 35px; border-top: 1px solid #222; z-index: 1000; }
        .dock-item { opacity: 0.4; font-size: 0.65rem; text-align: center; color: white; flex: 1; cursor: pointer; }
        .dock-item.active { opacity: 1; color: var(--accent); }
        .withdraw-btn { background: var(--warning); color: black; font-size: 0.7rem; font-weight: 800; padding: 10px 20px; border-radius: 12px; border: none; }
        .roadmap-step { position: relative; padding-left: 20px; padding-bottom: 20px; border-left: 2px solid #222; }
        .roadmap-step.done { border-left: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div class="header-ui">
        <div style="font-weight: 800;">TRULEGEND</div>
        <button class="withdraw-btn" onclick="tg.showAlert('Withdrawal portal opens in Phase 3')">WITHDRAW</button>
    </div>

    <div id="tab-mine" class="screen active-screen">
        <div class="balance" id="balance" onclick="adminCheck()">0</div>
        <div style="text-align: center; margin-top: 20px;">
            <span style="background:rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border);">
                ‚ö° <span id="energy">1000</span> / 1000
            </span>
        </div>
        <div class="circle-btn" id="tap-btn">üíé</div>
    </div>

    <div id="tab-tasks" class="screen">
        <h2>Quests</h2>
        <div id="task-list">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>Join Telegram</b><br><small style="color:var(--accent);">+100,000 $TRU</small></div>
                <button class="withdraw-btn" id="btn-task-tg" onclick="doTask('tg', 'https://t.me/YourChannel', 100000)">GO</button>
            </div>
        </div>
    </div>

    <div id="tab-drop" class="screen">
        <h2>Airdrop Hub</h2>
        <div class="card" style="border-left: 4px solid var(--accent);">
            <b>Wallet Connection</b>
            <button class="withdraw-btn" style="width:100%; margin-top:10px; background:white; color:black;" onclick="tg.showAlert('Linking starts Phase 2')">CONNECT WALLET</button>
        </div>
        <h3>Roadmap</h3>
        <div class="roadmap-step done"><h4>Phase 1: Mining</h4><p>Community & $TRU Fair Launch</p></div>
        <div class="roadmap-step"><h4>Phase 2: Snapshot</h4><p>Verification & Tasks</p></div>
        <div class="roadmap-step"><h4>Phase 3: TGE</h4><p>Listing & Distribution</p></div>
    </div>

    <div id="tab-rank" class="screen">
        <h2>Leaderboard</h2>
        <div class="card" style="text-align:center; background:linear-gradient(45deg, #001a33, #0088cc); border:none;">
            <small>GLOBAL COMMUNITY TOTAL</small>
            <div id="global-total" style="font-size:1.5rem; font-weight:900;">0</div>
        </div>
        <div id="leader-list"></div>
    </div>

    <div class="dock">
        <div class="dock-item active" onclick="switchTab('mine', this)">‚õèÔ∏è<br>MINE</div>
        <div class="dock-item" onclick="switchTab('tasks', this)">üìã<br>TASKS</div>
        <div class="dock-item" onclick="switchTab('drop', this)">üí∞<br>DROP</div>
        <div class="dock-item" onclick="switchTab('rank', this)">üèÜ<br>RANK</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const firebaseConfig = {
            apiKey: "AIzaSyC2O8gD1lWx9QFS4FBZCrECjJ-icafg6ds",
            authDomain: "trulegend-be32e.firebaseapp.com",
            databaseURL: "https://trulegend-be32e-default-rtdb.firebaseio.com",
            projectId: "trulegend-be32e",
            storageBucket: "trulegend-be32e.firebasestorage.app",
            messagingSenderId: "462505787354",
            appId: "1:462505787354:web:60a34512cef1f26ef34ae3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const user = tg.initDataUnsafe?.user || { id: "test_user", first_name: "Legend" };
        let state = { balance: 0, energy: 1000, tasks: {}, friends: [], lastSync: Date.now() };

        function init() {
            db.ref('users/' + user.id).once('value', (snap) => {
                if(snap.exists()) {
                    state = { ...state, ...snap.val() };
                    const elapsed = Math.floor((Date.now() - (state.lastSync || Date.now())) / 4000);
                    state.energy = Math.min(1000, (state.energy || 0) + (elapsed * 4));
                    renderUI();
                } else { handleNewUser(); }
            });
            loadRankings(); 
        }

        async function handleNewUser() {
            const newUser = { id: user.id, username: user.first_name, balance: 0, energy: 1000, tasks: {}, lastSync: Date.now() };
            await db.ref('users/' + user.id).set(newUser);
            renderUI();
        }

        function renderUI() {
            document.getElementById('balance').innerText = Math.floor(state.balance).toLocaleString();
            document.getElementById('energy').innerText = state.energy;
            if(state.tasks?.tg) {
                const btn = document.getElementById('btn-task-tg');
                btn.innerText = "DONE";
                btn.style.opacity = "0.5";
                btn.disabled = true;
            }
        }

        function doTask(id, url, reward) {
            tg.openLink(url);
            setTimeout(() => {
                if(!state.tasks) state.tasks = {};
                if(!state.tasks[id]) {
                    state.balance += reward;
                    state.tasks[id] = true;
                    save();
                    renderUI();
                    tg.showAlert("Task Verified! +100,000 $TRU added.");
                }
            }, 5000);
        }

        document.getElementById('tap-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(state.energy >= 1) {
                state.balance += 1; state.energy -= 1;
                renderUI();
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                triggerSave();
            }
        });

        let saveTimeout;
        function triggerSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => save(), 1500); }
        function save() { 
            db.ref('users/' + user.id).update({ 
                balance: state.balance, energy: state.energy, tasks: state.tasks || {}, lastSync: Date.now() 
            }); 
        }

        function switchTab(t, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('tab-' + t).classList.add('active-screen');
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        function loadRankings() {
            db.ref('users').on('value', snap => {
                let players = [];
                let total = 0;
                snap.forEach(c => { 
                    const p = c.val();
                    players.push(p);
                    total += (p.balance || 0);
                });
                
                players.sort((a,b) => (b.balance || 0) - (a.balance || 0));
                document.getElementById('global-total').innerText = Math.floor(total).toLocaleString() + " $TRU";
                
                document.getElementById('leader-list').innerHTML = players.slice(0, 50).map((p, i) => `
                    <div class="rank-row" style="${p.id == user.id ? 'border:2px solid var(--accent); background:rgba(0,136,204,0.1);' : ''}">
                        <div style="display:flex; align-items:center;">
                            <span class="badge ${i==0?'top1':i==1?'top2':i==2?'top3':''}">${i+1}</span>
                            <b>${p.username || 'Legend'}</b>
                        </div>
                        <b>${Math.floor(p.balance || 0).toLocaleString()}</b>
                    </div>
                `).join('');
            });
        }

        let taps = 0;
        function adminCheck() { 
            taps++; 
            if(taps >= 5) { 
                let k = prompt("Admin Key?"); 
                if(k === "@2377Umar") { 
                    let a = prompt("Amount?"); 
                    db.ref('users/'+user.id).update({balance: state.balance + parseInt(a), adminKey: k}); 
                } 
                taps=0; 
            } 
        }

        setInterval(() => { if(state.energy < 1000) { state.energy = Math.min(1000, state.energy + 4); renderUI(); } }, 4000);
        init();
    </script>
</body>
</html>